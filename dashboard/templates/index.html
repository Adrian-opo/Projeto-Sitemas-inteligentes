{% load static %}
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="{% static 'img/logo.png' %}" />
  <link rel="stylesheet" href="{% static 'css/style.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <title>DashLog</title>
</head>

<body>
  <nav class="bg-white border-gray-200 shadow-sm">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
      <a href="#" class="flex items-center space-x-3 rtl:space-x-reverse">
        <img src="{% static 'img/logo.png' %}" class="h-8" alt="Logo" />
        <span class="self-center text-2xl font-semibold whitespace-nowrap text-white">
          DashLog
        </span>
      </a>
      <!-- Controles Arduino -->
      <div class="flex items-center gap-2 flex-wrap">
        <span id="arduino-status" class="text-sm text-gray-500">
          <i class="fas fa-circle text-red-500"></i> Desconectado
        </span>
        <select id="porta-arduino" class="text-sm border rounded px-2 py-1 bg-white" title="Selecione a porta do Arduino">
          <option value="">Carregando portas...</option>
        </select>
        <button onclick="carregarPortas()" 
          class="bg-gray-400 hover:bg-gray-500 text-white px-2 py-1 rounded text-sm" title="Atualizar lista de portas">
          <i class="fas fa-sync-alt"></i>
        </button>
        <button onclick="conectarArduino()" 
          class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
          <i class="fas fa-plug"></i> Conectar
        </button>
        <button onclick="iniciarCiclo()" 
          class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">
          <i class="fas fa-play"></i> Iniciar
        </button>
        <button onclick="interromperCiclo()" 
          class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">
          <i class="fas fa-stop"></i> Interromper
        </button>
        <button onclick="resetArduino()" 
          class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
          <i class="fas fa-undo"></i> Reset
        </button>
        <button onclick="uploadArduino()" 
          class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded text-sm">
          <i class="fas fa-upload"></i> Upload
        </button>
        <button onclick="location.reload()" 
          class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">
          <i class="fas fa-sync"></i> Atualizar
        </button>
      </div>
    </div>
  </nav>

  <main class="p-4 sm:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6 min-h-[calc(100vh-64px)]">
    <!-- Histórico (pode iniciar vazio) -->
    <section
      class="lg:col-span-4 bg-white rounded-2xl shadow-lg hover:shadow-xl transition p-4 sm:p-6 border border-gray-200 flex flex-col order-2 lg:order-1">
      <h2 class="text-lg font-semibold mb-4 border-l-4 border-[#FF6500] pl-2">
        Histórico
      </h2>
      <div id="historico-container"
        class="flex-1 overflow-y-auto bg-gray-50 rounded-lg p-4 text-sm text-gray-600 space-y-4 max-h-[calc(100vh-200px)]">
        <!-- Cards do histórico vão ser inseridos aqui dinamicamente via JS -->
      </div>
    </section>

    <!-- Coluna direita -->
    <div class="lg:col-span-8 grid grid-cols-1 gap-6 order-1 lg:order-2">
      <!-- Linha superior: Câmera + Códigos -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Câmera -->
        <section class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition p-4 sm:p-6 border border-gray-200">
          <h2 class="text-lg font-semibold mb-4 border-l-4 border-[#FF6500] pl-2">
            Câmera
          </h2>
          <div class="bg-gray-400 h-48 sm:h-64 rounded-xl flex items-center justify-center text-white font-medium">
            <img src="http://127.0.0.1:5001/video.mjpg?token=MEU_TOKEN_SEGURO"
              class="w-full h-full object-cover rounded-xl" alt="Stream da câmera" />
          </div>
        </section>

        <!-- Códigos -->
        <section class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition p-4 sm:p-6 border border-gray-200">
          <h2 class="text-lg font-semibold mb-4 border-l-4 border-[#FF6500] pl-2">
            Códigos
          </h2>

          <!-- GIF 1 -->
          <div class="flex justify-center items-center mb-4" id="gif1">
            <img class="w-24 sm:w-32 md:w-40 lg:w-48 xl:w-52 h-auto" src="{% static 'img/caixa-cod.gif' %}" alt="" />
          </div>

          <!-- Código -->
          <div class="flex justify-center items-center hidden mb-4" id="codigo">
            <div class="flex flex-col items-center">
              <div class="icon">
                <img class="w-24 sm:w-32 md:w-36 lg:w-40 h-auto" src="{% static 'img/cod-barras.png' %}" alt="" />
              </div>
              <strong><span class="text-black" id="codigo-texto"></span></strong>
            </div>
          </div>

          <!-- GIF 2 -->
          <div class="flex justify-center items-center hidden" id="gif2">
            <img class="w-24 sm:w-32 md:w-40 lg:w-48 xl:w-52 h-auto" src="{% static 'img/caixa-esteira.gif' %}"
              alt="" />
          </div>
        </section>
      </div>

      <!-- Linha inferior: Contagem por Região -->
      <section class="bg-white rounded-2xl shadow-lg hover:shadow-xl transition p-4 sm:p-6 border border-gray-200">
        <h2 class="text-lg font-semibold mb-4 border-l-4 border-[#FF6500] pl-2">
          Contagem por Região
        </h2>

        <!-- Sempre renderiza as caixas, mesmo com contagem = 0 -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
          <div
            class="bg-[#7AC789] text-white p-4 sm:p-6 rounded-lg text-center shadow-lg hover:shadow-xl transition transform hover:scale-105 aspect-square flex flex-col items-center justify-center">
            <i class="fas fa-tree text-2xl sm:text-3xl mb-2"></i>
            <span class="text-lg sm:text-xl font-bold">Norte</span>
            <span class="text-base sm:text-lg" id="norte-count">0</span>
          </div>

          <div
            class="bg-[#FF6F61] text-white p-4 sm:p-6 rounded-lg text-center shadow-lg hover:shadow-xl transition transform hover:scale-105 aspect-square flex flex-col items-center justify-center">
            <i class="fas fa-sun text-2xl sm:text-3xl mb-2"></i>
            <span class="text-lg sm:text-xl font-bold">Nordeste</span>
            <span class="text-base sm:text-lg" id="nordeste-count">0</span>
          </div>

          <div
            class="bg-[#6A5ACD] text-white p-4 sm:p-6 rounded-lg text-center shadow-lg hover:shadow-xl transition transform hover:scale-105 aspect-square flex flex-col items-center justify-center">
            <i class="fas fa-water text-2xl sm:text-3xl mb-2"></i>
            <span class="text-lg sm:text-xl font-bold">Sul</span>
            <span class="text-base sm:text-lg" id="sul-count">0</span>
          </div>

          <div
            class="bg-[#FFD700] text-white p-4 sm:p-6 rounded-lg text-center shadow-lg hover:shadow-xl transition transform hover:scale-105 aspect-square flex flex-col items-center justify-center">
            <i class="fas fa-city text-2xl sm:text-3xl mb-2"></i>
            <span class="text-lg sm:text-xl font-bold">Sudeste</span>
            <span class="text-base sm:text-lg" id="sudeste-count">0</span>
          </div>

          <div
            class="bg-[#FF4500] text-white p-4 sm:p-6 rounded-lg text-center shadow-lg hover:shadow-xl transition transform hover:scale-105 aspect-square flex flex-col items-center justify-center">
            <i class="fas fa-flag-checkered text-2xl sm:text-3xl mb-2"></i>
            <span class="text-lg sm:text-xl font-bold">Centro-Oeste</span>
            <span class="text-base sm:text-lg" id="co-count">0</span>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    let ultimoCodigo = null; // Para não repetir o mesmo pacote

    async function getPacote() {
      try {
        const resp = await fetch("/api/pacote/"); // rota GET para frontend
        const data = await resp.json();

        if (!data.pacotes || data.pacotes.length === 0) return null;

        return data.pacotes[0]; // pega o pacote mais recente
      } catch (e) {
        console.error("Erro ao buscar pacote:", e);
        return null;
      }
    }

    const regioesConfig = {
      norte: { cor: "#7AC789", icone: "fas fa-tree" },
      nordeste: { cor: "#FF6F61", icone: "fas fa-sun" },
      sul: { cor: "#6A5ACD", icone: "fas fa-water" },
      sudeste: { cor: "#FFD700", icone: "fas fa-city" },
      "centro-oeste": { cor: "#FF4500", icone: "fas fa-flag-checkered" },
    };

    const regioesId = {
      norte: "norte-count",
      nordeste: "nordeste-count",
      sul: "sul-count",
      sudeste: "sudeste-count",
      "centro-oeste": "co-count",
    };

    function atualizarHistorico(nome, codigo, regiao) {
      const historico = document.getElementById("historico-container");
      const novoItem = document.createElement("div");
      novoItem.className = "card flex items-center gap-3 p-2";

      const config = regioesConfig[regiao.toLowerCase()] || {
        cor: "#999999",
        icone: "fas fa-box",
      };

      novoItem.innerHTML = `
      <div class="text-white w-16 h-16 rounded-lg flex items-center justify-center"
           style="background-color: ${config.cor}">
        <i class="${config.icone} text-2xl"></i>
      </div>
      <div class="text-container">
        <p class="text-lg font-semibold">${nome}</p>
        <p class="sub-text">${codigo}</p>
      </div>
    `;

      historico.prepend(novoItem);
    }

    function incrementarContagem(regiao) {
      const id = regioesId[regiao.toLowerCase()];
      if (!id) return;
      const span = document.getElementById(id);
      if (span) {
        span.textContent = parseInt(span.textContent) + 1;
      }
    }

    async function ciclo() {
      const gif1 = document.getElementById("gif1");
      const codigoDiv = document.getElementById("codigo");
      const codigoTexto = document.getElementById("codigo-texto");
      const gif2 = document.getElementById("gif2");

      gif1.classList.remove("hidden");
      codigoDiv.classList.add("hidden");
      gif2.classList.add("hidden");

      const pacote = await getPacote();
      if (!pacote || pacote.codigo === ultimoCodigo) return; // evita duplicatas
      ultimoCodigo = pacote.codigo;

      gif1.classList.add("hidden");
      codigoTexto.textContent = pacote.codigo;
      codigoDiv.classList.remove("hidden");

      atualizarHistorico(pacote.nome, pacote.codigo, pacote.regiao);
      incrementarContagem(pacote.regiao);

      setTimeout(() => {
        codigoDiv.classList.add("hidden");
        gif2.classList.remove("hidden");

        setTimeout(() => {
          gif2.classList.add("hidden");
          gif1.classList.remove("hidden");
        }, 2000);
      }, 2000);
    }

    document.addEventListener("DOMContentLoaded", () => {
      ciclo();
      setInterval(ciclo, 2000); // polling rápido a cada 2s
      atualizarStatusArduino(); // verifica status inicial
      setInterval(atualizarStatusArduino, 5000); // atualiza status a cada 5s
      carregarPortas(); // carrega portas disponíveis
    });

    // ===== CONTROLE ARDUINO =====
    async function carregarPortas() {
      const select = document.getElementById('porta-arduino');
      try {
        const resp = await fetch("/api/arduino/portas/");
        const data = await resp.json();
        select.innerHTML = '';
        
        if (data.portas.length === 0) {
          select.innerHTML = '<option value="">Nenhuma porta encontrada</option>';
        } else {
          data.portas.forEach(p => {
            const option = document.createElement('option');
            option.value = p.dispositivo;
            option.textContent = `${p.dispositivo} (${p.descricao})`;
            select.appendChild(option);
          });
        }
      } catch (e) {
        select.innerHTML = '<option value="">Erro ao carregar</option>';
        console.error("Erro ao carregar portas:", e);
      }
    }

    async function atualizarStatusArduino() {
      try {
        const resp = await fetch("/api/arduino/status/");
        const data = await resp.json();
        const statusEl = document.getElementById("arduino-status");
        
        if (data.conectado) {
          statusEl.innerHTML = `<i class="fas fa-circle text-green-500"></i> Conectado`;
          if (data.aguardando_qr) {
            statusEl.innerHTML += ` <span class="text-yellow-500">(Aguardando QR)</span>`;
          }
        } else {
          statusEl.innerHTML = `<i class="fas fa-circle text-red-500"></i> Desconectado`;
        }
      } catch (e) {
        console.error("Erro ao verificar status:", e);
      }
    }

    async function conectarArduino() {
      const porta = document.getElementById('porta-arduino').value;
      try {
        const resp = await fetch("/api/arduino/conectar/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ porta: porta })
        });
        const data = await resp.json();
        alert(data.sucesso ? "✅ Arduino conectado em " + porta + "!" : "❌ Falha: " + data.mensagem);
        atualizarStatusArduino();
      } catch (e) {
        alert("❌ Erro ao conectar: " + e.message);
      }
    }

    async function iniciarCiclo() {
      try {
        const resp = await fetch("/api/arduino/iniciar/", { method: "POST" });
        const data = await resp.json();
        if (data.sucesso) {
          alert("✅ Ciclo iniciado! Garra pegando objeto...");
        } else {
          alert("❌ Erro: " + JSON.stringify(data.resposta));
        }
        atualizarStatusArduino();
      } catch (e) {
        alert("❌ Erro: " + e.message);
      }
    }

    async function interromperCiclo() {
      if (!confirm("Tem certeza que deseja interromper o ciclo?")) return;
      try {
        const resp = await fetch("/api/arduino/interromper/", { method: "POST" });
        const data = await resp.json();
        alert(data.sucesso ? "⏹️ Ciclo interrompido!" : "❌ Falha: " + data.mensagem);
        atualizarStatusArduino();
      } catch (e) {
        alert("❌ Erro: " + e.message);
      }
    }

    async function resetArduino() {
      if (!confirm("Tem certeza que deseja resetar o Arduino?")) return;
      try {
        const resp = await fetch("/api/arduino/reset/", { method: "POST" });
        const data = await resp.json();
        alert(data.sucesso ? "✅ Arduino resetado!" : "❌ Falha no reset");
        atualizarStatusArduino();
      } catch (e) {
        alert("❌ Erro: " + e.message);
      }
    }

    async function uploadArduino() {
      if (!confirm("Fazer upload do código para o Arduino?\n\nIsso vai compilar e enviar o código para o dispositivo.")) return;
      alert("⏳ Iniciando upload... Aguarde, pode demorar alguns segundos.");
      try {
        const resp = await fetch("/api/arduino/upload/", { method: "POST" });
        const data = await resp.json();
        if (data.sucesso) {
          alert("✅ Upload concluído com sucesso!\n\n" + (data.mensagem || ""));
        } else {
          alert("❌ Erro no upload:\n" + (data.mensagem || data.erro || "Erro desconhecido"));
        }
        atualizarStatusArduino();
      } catch (e) {
        alert("❌ Erro: " + e.message);
      }
    }
  </script>
</body>

</html>